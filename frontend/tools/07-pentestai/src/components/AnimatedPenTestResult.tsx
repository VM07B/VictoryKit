import React, { useEffect, useState } from "react";
import {
  Shield,
  ShieldAlert,
  ShieldCheck,
  ShieldX,
  AlertTriangle,
  CheckCircle,
  XCircle,
  Target,
  Zap,
  Bug,
  Lock,
  Unlock,
  Key,
  Server,
  Globe,
  Clock,
  Download,
  RefreshCw,
  ChevronDown,
  ChevronUp,
  ExternalLink,
  Terminal,
  FileText,
  Award,
} from "lucide-react";

export type ThreatLevel = "CRITICAL" | "HIGH" | "MEDIUM" | "LOW" | "SECURE";

export interface ExploitResult {
  id: string;
  name: string;
  module: string;
  severity: "critical" | "high" | "medium" | "low";
  status: "success" | "failed";
  target: string;
  payload?: string;
  accessGained?: "none" | "user" | "root" | "system";
  evidence?: string;
  remediation?: string;
}

export interface PenTestResult {
  threatLevel: ThreatLevel;
  overallScore: number; // 0-100 (100 = most vulnerable)
  target: string;
  testType: string;
  summary: string;
  exploitsAttempted: number;
  exploitsSuccessful: number;
  accessLevel: "none" | "user" | "root" | "system";
  exploits: ExploitResult[];
  findings: {
    category: string;
    count: number;
    severity: "critical" | "high" | "medium" | "low" | "info";
  }[];
  recommendations: string[];
  complianceIssues: string[];
  testDuration: number;
}

interface AnimatedPenTestResultProps {
  result: PenTestResult;
  onNewTest: () => void;
  onExport: () => void;
}

const AnimatedPenTestResult: React.FC<AnimatedPenTestResultProps> = ({
  result,
  onNewTest,
  onExport,
}) => {
  const [showScore, setShowScore] = useState(false);
  const [animatedScore, setAnimatedScore] = useState(0);
  const [expandedExploit, setExpandedExploit] = useState<string | null>(null);
  const [showFindings, setShowFindings] = useState(true);
  const [showExploits, setShowExploits] = useState(true);

  useEffect(() => {
    const timer = setTimeout(() => setShowScore(true), 100);
    return () => clearTimeout(timer);
  }, []);

  useEffect(() => {
    if (showScore) {
      let current = 0;
      const target = result.overallScore;
      const increment = target / 40;
      const interval = setInterval(() => {
        current += increment;
        if (current >= target) {
          setAnimatedScore(target);
          clearInterval(interval);
        } else {
          setAnimatedScore(Math.floor(current));
        }
      }, 25);
      return () => clearInterval(interval);
    }
  }, [showScore, result.overallScore]);

  const getThreatConfig = () => {
    switch (result.threatLevel) {
      case "CRITICAL":
        return {
          color: "text-red-400",
          bg: "bg-red-500/20",
          border: "border-red-500/50",
          gradient: "from-red-500 to-red-600",
          icon: ShieldX,
          glow: "shadow-red-500/30",
          label: "CRITICAL BREACH",
        };
      case "HIGH":
        return {
          color: "text-orange-400",
          bg: "bg-orange-500/20",
          border: "border-orange-500/50",
          gradient: "from-orange-500 to-orange-600",
          icon: ShieldAlert,
          glow: "shadow-orange-500/30",
          label: "HIGH RISK",
        };
      case "MEDIUM":
        return {
          color: "text-yellow-400",
          bg: "bg-yellow-500/20",
          border: "border-yellow-500/50",
          gradient: "from-yellow-500 to-yellow-600",
          icon: AlertTriangle,
          glow: "shadow-yellow-500/30",
          label: "MEDIUM RISK",
        };
      case "LOW":
        return {
          color: "text-cyan-400",
          bg: "bg-cyan-500/20",
          border: "border-cyan-500/50",
          gradient: "from-cyan-500 to-cyan-600",
          icon: Shield,
          glow: "shadow-cyan-500/30",
          label: "LOW RISK",
        };
      default:
        return {
          color: "text-green-400",
          bg: "bg-green-500/20",
          border: "border-green-500/50",
          gradient: "from-green-500 to-green-600",
          icon: ShieldCheck,
          glow: "shadow-green-500/30",
          label: "SECURE",
        };
    }
  };

  const config = getThreatConfig();
  const Icon = config.icon;

  const getAccessBadge = () => {
    switch (result.accessLevel) {
      case "system":
        return {
          label: "SYSTEM",
          color: "text-purple-400 bg-purple-500/20 border-purple-500/50",
          icon: Shield,
        };
      case "root":
        return {
          label: "ROOT",
          color: "text-red-400 bg-red-500/20 border-red-500/50",
          icon: Unlock,
        };
      case "user":
        return {
          label: "USER",
          color: "text-yellow-400 bg-yellow-500/20 border-yellow-500/50",
          icon: Lock,
        };
      default:
        return {
          label: "NONE",
          color: "text-gray-400 bg-gray-500/20 border-gray-500/50",
          icon: Lock,
        };
    }
  };

  const accessBadge = getAccessBadge();
  const AccessIcon = accessBadge.icon;

  return (
    <div
      className={`attack-card p-6 space-y-6 transition-all duration-500 ${
        showScore ? "opacity-100 translate-y-0" : "opacity-0 translate-y-4"
      }`}
    >
      {/* Header */}
      <div className="text-center space-y-4">
        {/* Threat Icon */}
        <div
          className={`relative w-24 h-24 mx-auto rounded-2xl bg-gradient-to-br ${config.gradient} flex items-center justify-center shadow-xl ${config.glow} animate-attackPulse`}
        >
          <Icon className="w-12 h-12 text-white" />
          {result.accessLevel !== "none" && (
            <div className="absolute -bottom-2 -right-2 w-8 h-8 rounded-full bg-slate-900 border-2 border-red-500 flex items-center justify-center">
              <Unlock className="w-4 h-4 text-red-400" />
            </div>
          )}
        </div>

        {/* Threat Level */}
        <div>
          <span
            className={`inline-flex items-center gap-2 px-4 py-1.5 rounded-full ${config.bg} ${config.border} border`}
          >
            <span
              className={`text-sm font-black tracking-wider ${config.color}`}
            >
              {config.label}
            </span>
          </span>
        </div>

        {/* Score */}
        <div className="relative">
          <div className={`text-6xl font-black ${config.color} tabular-nums`}>
            {animatedScore}
          </div>
          <p className="text-sm text-gray-500 mt-1">Breach Risk Score</p>
        </div>
      </div>

      {/* Stats Grid */}
      <div className="grid grid-cols-3 gap-3">
        <div className="p-3 bg-slate-800/50 rounded-lg text-center">
          <Zap className="w-5 h-5 text-red-400 mx-auto mb-1" />
          <p className="text-lg font-bold text-white">
            {result.exploitsSuccessful}/{result.exploitsAttempted}
          </p>
          <p className="text-[10px] text-gray-500">Exploits</p>
        </div>
        <div
          className={`p-3 rounded-lg text-center border ${accessBadge.color}`}
        >
          <AccessIcon className="w-5 h-5 mx-auto mb-1" />
          <p className="text-lg font-bold">{accessBadge.label}</p>
          <p className="text-[10px] opacity-70">Access Level</p>
        </div>
        <div className="p-3 bg-slate-800/50 rounded-lg text-center">
          <Clock className="w-5 h-5 text-cyan-400 mx-auto mb-1" />
          <p className="text-lg font-bold text-white">
            {(result.testDuration / 1000).toFixed(1)}s
          </p>
          <p className="text-[10px] text-gray-500">Duration</p>
        </div>
      </div>

      {/* Target */}
      <div className="p-4 bg-slate-800/30 rounded-lg">
        <div className="flex items-center gap-3">
          <Target className="w-5 h-5 text-red-400" />
          <div>
            <p className="text-sm font-medium text-white font-mono">
              {result.target}
            </p>
            <p className="text-xs text-gray-500">
              {result.testType} Penetration Test
            </p>
          </div>
        </div>
      </div>

      {/* Summary */}
      <p className="text-sm text-gray-300 leading-relaxed">{result.summary}</p>

      {/* Findings Breakdown */}
      <div className="space-y-3">
        <button
          onClick={() => setShowFindings(!showFindings)}
          className="flex items-center justify-between w-full text-sm font-semibold text-gray-300 hover:text-white"
        >
          <span className="flex items-center gap-2">
            <Bug className="w-4 h-4 text-orange-400" />
            Vulnerability Findings
          </span>
          {showFindings ? (
            <ChevronUp className="w-4 h-4" />
          ) : (
            <ChevronDown className="w-4 h-4" />
          )}
        </button>

        {showFindings && (
          <div className="grid grid-cols-2 gap-2">
            {result.findings.map((finding, idx) => (
              <div
                key={idx}
                className={`p-3 rounded-lg border ${
                  finding.severity === "critical"
                    ? "severity-critical"
                    : finding.severity === "high"
                    ? "severity-high"
                    : finding.severity === "medium"
                    ? "severity-medium"
                    : finding.severity === "low"
                    ? "severity-low"
                    : "severity-info"
                }`}
              >
                <p className="text-lg font-bold">{finding.count}</p>
                <p className="text-xs opacity-80">{finding.category}</p>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Successful Exploits */}
      {result.exploits.filter((e) => e.status === "success").length > 0 && (
        <div className="space-y-3">
          <button
            onClick={() => setShowExploits(!showExploits)}
            className="flex items-center justify-between w-full text-sm font-semibold text-gray-300 hover:text-white"
          >
            <span className="flex items-center gap-2">
              <Zap className="w-4 h-4 text-red-400" />
              Successful Exploits
            </span>
            {showExploits ? (
              <ChevronUp className="w-4 h-4" />
            ) : (
              <ChevronDown className="w-4 h-4" />
            )}
          </button>

          {showExploits && (
            <div className="space-y-2">
              {result.exploits
                .filter((e) => e.status === "success")
                .map((exploit) => (
                  <div
                    key={exploit.id}
                    className={`p-3 rounded-lg border cursor-pointer transition-all ${
                      exploit.severity === "critical"
                        ? "severity-critical"
                        : exploit.severity === "high"
                        ? "severity-high"
                        : "severity-medium"
                    } ${
                      expandedExploit === exploit.id
                        ? "ring-1 ring-red-500"
                        : ""
                    }`}
                    onClick={() =>
                      setExpandedExploit(
                        expandedExploit === exploit.id ? null : exploit.id
                      )
                    }
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <CheckCircle className="w-4 h-4 text-green-400" />
                        <span className="text-sm font-medium">
                          {exploit.name}
                        </span>
                      </div>
                      <span className="exploit-badge">{exploit.severity}</span>
                    </div>

                    {expandedExploit === exploit.id && (
                      <div className="mt-3 pt-3 border-t border-white/10 space-y-2 text-xs">
                        <div className="flex items-center gap-2">
                          <Terminal className="w-3 h-3 text-gray-400" />
                          <span className="font-mono text-gray-400">
                            {exploit.module}
                          </span>
                        </div>
                        {exploit.accessGained &&
                          exploit.accessGained !== "none" && (
                            <div className="flex items-center gap-2">
                              <Unlock className="w-3 h-3 text-red-400" />
                              <span className="text-red-400 font-bold">
                                {exploit.accessGained.toUpperCase()} ACCESS
                              </span>
                            </div>
                          )}
                        {exploit.evidence && (
                          <div className="p-2 bg-black/30 rounded font-mono text-[10px] text-gray-400">
                            {exploit.evidence}
                          </div>
                        )}
                        {exploit.remediation && (
                          <div className="p-2 bg-green-500/10 rounded text-green-400">
                            <strong>Fix:</strong> {exploit.remediation}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                ))}
            </div>
          )}
        </div>
      )}

      {/* Recommendations */}
      <div className="space-y-3">
        <h4 className="text-sm font-semibold text-gray-300 flex items-center gap-2">
          <Award className="w-4 h-4 text-cyan-400" />
          Recommendations
        </h4>
        <div className="space-y-2">
          {result.recommendations.slice(0, 5).map((rec, idx) => (
            <div key={idx} className="flex items-start gap-2 text-sm">
              <CheckCircle className="w-4 h-4 text-green-400 shrink-0 mt-0.5" />
              <span className="text-gray-400">{rec}</span>
            </div>
          ))}
        </div>
      </div>

      {/* Compliance Issues */}
      {result.complianceIssues.length > 0 && (
        <div className="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg space-y-2">
          <h4 className="text-sm font-semibold text-yellow-400 flex items-center gap-2">
            <AlertTriangle className="w-4 h-4" />
            Compliance Concerns
          </h4>
          <ul className="space-y-1">
            {result.complianceIssues.map((issue, idx) => (
              <li key={idx} className="text-xs text-yellow-300">
                â€¢ {issue}
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Actions */}
      <div className="flex gap-3 pt-2">
        <button
          onClick={onNewTest}
          className="flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-lg bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white font-semibold transition-all shadow-lg shadow-red-500/25"
        >
          <RefreshCw className="w-4 h-4" />
          New Test
        </button>
        <button
          onClick={onExport}
          className="flex items-center justify-center gap-2 py-3 px-4 rounded-lg bg-slate-800 border border-slate-700 text-gray-300 hover:bg-slate-700 transition-all"
        >
          <Download className="w-4 h-4" />
          Export
        </button>
      </div>
    </div>
  );
};

export default AnimatedPenTestResult;
